"use strict";function GameEngine(){var e=document.createElement("a");e.href="/#games",e.innerText="Back",e.className="btnBack",document.body.appendChild(e);var t=document.createElement("div");t.className="canvasWrap",window.canvas=document.createElement("canvas"),canvas.setAttribute("width",1008),canvas.setAttribute("height",567),t.appendChild(canvas),document.body.appendChild(t),window.ctx=canvas.getContext("2d"),this.input=new GameInput(this),this.graphics=new GameGraphics(this),this.utils=new GameUtils(this),this.view=new GameView(this),this.init()}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function GameInput(){this.keysDown={},this.lastKeyUp=KeyCode.EMPTY,this.lastKeyDown=KeyCode.EMPTY,this.init()}function GameUtils(e){return{switchView:function(t){t.init(),e.view=t}}}function GameView(e){this.privates={bgColor:"#ccc"},this.init()}function TitleView(e){this.privates={title:e},this.init()}function GameSaveView(){this.privates={},this.init()}function LevelView(e,t){this.privates={},this.player=e,this.curLvl=t,this.init()}function Level1(){this.init()}function Vamp(){this.init()}GameEngine.prototype=function(){function e(){n.view.update(),r&&n.onUpdate()}function t(){o=requestAnimationFrame(t),n.view.render(),s&&n.onRender()}var n=void 0,i=void 0,o=void 0,r=!1,s=!1;return{init:function(){n=this},onUpdate:function(e){r=!0,this.onUpdate=e},onRender:function(e){s=!0,this.onRender=e},start:function(){i=setInterval(e,1e3/60),o=requestAnimationFrame(t)},stop:function(){clearInterval(i),cancelAnimationFrame(o)}}}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),GameSave=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"load",value:function(e){return localStorage["slot "+e]}},{key:"getList",value:function(){var e=this.load(0),t=this.load(1),n=this.load(2),i="---";return["undefined"!=typeof e?e:i,"undefined"!=typeof t?t:i,"undefined"!=typeof n?n:i]}},{key:"save",value:function(e,t){localStorage["slot "+e]=t}},{key:"erase",value:function(e){return localStorage.removeItem("slot "+e),this.getList()}}]),e}();GameInput.prototype=function(){function e(e){return e===KeyCode.W?e=KeyCode.UP:e===KeyCode.S?e=KeyCode.DOWN:e===KeyCode.D?e=KeyCode.RIGHT:e===KeyCode.A&&(e=KeyCode.LEFT),e}var t=void 0;return addEventListener("keydown",function(n){var i=e(n.keyCode);t.keysDown[i]||(t.lastKeyDown=i,t.keysDown[i]=!0)}),addEventListener("keyup",function(n){t.lastKeyUp=e(n.keyCode),delete t.keysDown[t.lastKeyUp]}),{init:function(){t=this},update:function(){}}}();var KeyCode=Object.freeze({EMPTY:-1,ENTER:13,CTRL:17,ESC:27,SPACEBAR:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,A:65,D:68,F:70,H:72,J:74,K:75,M:77,O:79,R:82,S:83,W:87}),KeyCodeNames={};KeyCodeNames[-1]="EMPTY",KeyCodeNames[13]="ENTER",KeyCodeNames[17]="CTRL",KeyCodeNames[27]="ESC",KeyCodeNames[32]="SPACEBAR",KeyCodeNames[37]="LEFT",KeyCodeNames[38]="UP",KeyCodeNames[39]="RIGHT",KeyCodeNames[40]="DOWN",KeyCodeNames[46]="DELETE",KeyCodeNames[65]="A",KeyCodeNames[68]="D",KeyCodeNames[70]="F",KeyCodeNames[72]="H",KeyCodeNames[74]="J",KeyCodeNames[75]="K",KeyCodeNames[77]="M",KeyCodeNames[79]="O",KeyCodeNames[82]="R",KeyCodeNames[83]="S",KeyCodeNames[87]="W";var Dir=Object.freeze({RIGHT:0,LEFT:1});!function(e,t){"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t():e.SAT=t()}(this,function(){function e(e,t){this.x=e||0,this.y=t||0}function t(t,n){this.pos=t||new e,this.r=n||0}function n(t,n){this.pos=t||new e,this.points=n||[],this.recalc()}function i(t,n,i){this.pos=t||new e,this.w=n||0,this.h=i||0}function o(){this.a=null,this.b=null,this.overlapN=new e,this.overlapV=new e,this.clear()}function r(e,t,n){for(var i=Number.MAX_VALUE,o=-Number.MAX_VALUE,r=e.length,s=0;s<r;s++){var a=e[s].dot(t);a<i&&(i=a),a>o&&(o=a)}n[0]=i,n[1]=o}function s(e,t,n,i,o,s){var a=v.pop(),p=v.pop(),l=y.pop().copy(t).sub(e),c=l.dot(o);if(r(n,o,a),r(i,o,p),p[0]+=c,p[1]+=c,a[0]>p[1]||p[0]>a[1])return y.push(l),v.push(a),v.push(p),!0;if(s){var h=0;if(a[0]<p[0])if(s.aInB=!1,a[1]<p[1])h=a[1]-p[0],s.bInA=!1;else{var u=a[1]-p[0],f=p[1]-a[0];h=u<f?u:-f}else if(s.bInA=!1,a[1]>p[1])h=a[0]-p[1],s.aInB=!1;else{var u=a[1]-p[0],f=p[1]-a[0];h=u<f?u:-f}var d=Math.abs(h);d<s.overlap&&(s.overlap=d,s.overlapN.copy(o),h<0&&s.overlapN.reverse())}return y.push(l),v.push(a),v.push(p),!1}function a(e,t){var n=e.len2(),i=t.dot(e);return i<0?d:i>n?w:m}function p(e,t,n){var i=y.pop().copy(t.pos).sub(e.pos),o=e.r+t.r,r=o*o,s=i.len2();if(s>r)return y.push(i),!1;if(n){var a=Math.sqrt(s);n.a=e,n.b=t,n.overlap=o-a,n.overlapN.copy(i.normalize()),n.overlapV.copy(i).scale(n.overlap),n.aInB=e.r<=t.r&&a<=t.r-e.r,n.bInA=t.r<=e.r&&a<=e.r-t.r}return y.push(i),!0}function l(e,t,n){for(var i=y.pop().copy(t.pos).sub(e.pos),o=t.r,r=o*o,s=e.points,p=s.length,l=y.pop(),c=y.pop(),h=0;h<p;h++){var u=h===p-1?0:h+1,f=0===h?p-1:h-1,v=0,m=null;l.copy(e.edges[h]),c.copy(i).sub(s[h]),n&&c.len2()>r&&(n.aInB=!1);var x=a(l,c);if(x===d){l.copy(e.edges[f]);var g=y.pop().copy(i).sub(s[f]);if(x=a(l,g),x===w){var C=c.len();if(C>o)return y.push(i),y.push(l),y.push(c),y.push(g),!1;n&&(n.bInA=!1,m=c.normalize(),v=o-C)}y.push(g)}else if(x===w){if(l.copy(e.edges[u]),c.copy(i).sub(s[u]),x=a(l,c),x===d){var C=c.len();if(C>o)return y.push(i),y.push(l),y.push(c),!1;n&&(n.bInA=!1,m=c.normalize(),v=o-C)}}else{var K=l.perp().normalize(),C=c.dot(K),b=Math.abs(C);if(C>0&&b>o)return y.push(i),y.push(K),y.push(c),!1;n&&(m=K,v=o-C,(C>=0||v<2*o)&&(n.bInA=!1))}m&&n&&Math.abs(v)<Math.abs(n.overlap)&&(n.overlap=v,n.overlapN.copy(m))}return n&&(n.a=e,n.b=t,n.overlapV.copy(n.overlapN).scale(n.overlap)),y.push(i),y.push(l),y.push(c),!0}function c(e,t,n){var i=l(t,e,n);if(i&&n){var o=n.a,r=n.aInB;n.overlapN.reverse(),n.overlapV.reverse(),n.a=n.b,n.b=o,n.aInB=n.bInA,n.bInA=r}return i}function h(e,t,n){for(var i=e.points,o=i.length,r=t.points,a=r.length,p=0;p<o;p++)if(s(e.pos,t.pos,i,r,e.normals[p],n))return!1;for(var p=0;p<a;p++)if(s(e.pos,t.pos,i,r,t.normals[p],n))return!1;return n&&(n.a=e,n.b=t,n.overlapV.copy(n.overlapN).scale(n.overlap)),!0}var u={};u.Vector=e,u.V=e,e.prototype.copy=e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this},e.prototype.perp=e.prototype.perp=function(){var e=this.x;return this.x=this.y,this.y=-e,this},e.prototype.rotate=e.prototype.rotate=function(e){var t=this.x,n=this.y;return this.x=t*Math.cos(e)-n*Math.sin(e),this.y=t*Math.sin(e)+n*Math.cos(e),this},e.prototype.reverse=e.prototype.reverse=function(){return this.x=-this.x,this.y=-this.y,this},e.prototype.normalize=e.prototype.normalize=function(){var e=this.len();return e>0&&(this.x=this.x/e,this.y=this.y/e),this},e.prototype.add=e.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this},e.prototype.sub=e.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this},e.prototype.scale=e.prototype.scale=function(e,t){return this.x*=e,this.y*=t||e,this},e.prototype.project=e.prototype.project=function(e){var t=this.dot(e)/e.len2();return this.x=t*e.x,this.y=t*e.y,this},e.prototype.projectN=e.prototype.projectN=function(e){var t=this.dot(e);return this.x=t*e.x,this.y=t*e.y,this},e.prototype.reflect=e.prototype.reflect=function(e){var t=this.x,n=this.y;return this.project(e).scale(2),this.x-=t,this.y-=n,this},e.prototype.reflectN=e.prototype.reflectN=function(e){var t=this.x,n=this.y;return this.projectN(e).scale(2),this.x-=t,this.y-=n,this},e.prototype.dot=e.prototype.dot=function(e){return this.x*e.x+this.y*e.y},e.prototype.len2=e.prototype.len2=function(){return this.dot(this)},e.prototype.len=e.prototype.len=function(){return Math.sqrt(this.len2())},u.Circle=t,u.Polygon=n,n.prototype.recalc=n.prototype.recalc=function(){this.edges=[],this.normals=[];for(var t=this.points,n=t.length,i=0;i<n;i++){var o=t[i],r=i<n-1?t[i+1]:t[0],s=(new e).copy(r).sub(o),a=(new e).copy(s).perp().normalize();this.edges.push(s),this.normals.push(a)}return this},n.prototype.rotate=n.prototype.rotate=function(e){var t,n=this.points,i=this.edges,o=this.normals,r=n.length;for(t=0;t<r;t++)n[t].rotate(e),i[t].rotate(e),o[t].rotate(e);return this},n.prototype.translate=n.prototype.translate=function(e,t){var n,i=this.points,o=i.length;for(n=0;n<o;n++)i[n].x+=e,i[n].y+=t;return this},u.Box=i,i.prototype.toPolygon=i.prototype.toPolygon=function(){var t=this.pos,i=this.w,o=this.h;return new n(new e(t.x,t.y),[new e,new e(i,0),new e(i,o),new e(0,o)])},u.Response=o,o.prototype.clear=o.prototype.clear=function(){return this.aInB=!0,this.bInA=!0,this.overlap=Number.MAX_VALUE,this};for(var y=[],f=0;f<10;f++)y.push(new e);for(var v=[],f=0;f<5;f++)v.push([]);var d=-1,m=0,w=1;return u.testCircleCircle=p,u.testPolygonCircle=l,u.testCirclePolygon=c,u.testPolygonPolygon=h,u});var GameGraphics=function(e){return{isAnimating:!1,repeatAction:function(e,t,n){this.isAnimating=!0;var i=0,o=this,r=setInterval(function(){i++>t?(clearInterval(r),o.isAnimating=!1):n()},e)}}};GameView.prototype=function(){return{then:function(e){this.privates.callback=e},init:function(){},update:function(){},render:function(){ctx.fillStyle=this.privates.bgColor,ctx.fillRect(0,0,canvas.width,canvas.height)}}}(),TitleView.prototype=function(){var e=void 0,t="Press Enter";return{then:function(e){this.privates.callback=e},init:function(){e=this.privates.title},update:function(){game.input.lastKeyDown===KeyCode.ENTER&&(game.input.lastKeyDown=KeyCode.EMPTY,this.privates.callback())},render:function(){ctx.fillStyle="#000",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.font="36px Arial",ctx.fillStyle="#fff",ctx.fillText(e,canvas.width/2-ctx.measureText(e).width/2,100),ctx.font="24px Arial",ctx.fillText(t,canvas.width/2-ctx.measureText(t).width/2,canvas.height/2)}}}(),GameSaveView.prototype=function(){var e,t,n="Select a save slot",i=new GameSave,o=i.getList();return{then:function(e){this.privates.callback=e},init:function(){e=this,t={img:">>",slot:0,x:canvas.width/2-ctx.measureText(o[0]).width/2-60,y:200}},update:function(){if(game.input.lastKeyDown===KeyCode.ESC)game.input.lastKeyDown=KeyCode.EMPTY,this.privates.callback(KeyCode.ESC);else if(game.input.lastKeyDown===KeyCode.ENTER){game.input.lastKeyDown=KeyCode.EMPTY;var e=new Date,n=e.getMonth(),r=e.getDay(),s=e.getYear(),a=e.toLocaleTimeString();i.save(t.slot,n+"/"+r+"/"+s+" "+a),this.privates.callback(KeyCode.ENTER)}else game.input.lastKeyDown===KeyCode.DELETE?(game.input.lastKeyDownp=KeyCode.EMPTY,o=i.erase(t.slot)):2!==t.slot&&game.input.lastKeyDown===KeyCode.DOWN?(game.input.lastKeyDown=KeyCode.EMPTY,++t.slot,t.x=canvas.width/2-ctx.measureText(o[t.slot]).width/2-60,t.y+=80):0!==t.slot&&game.input.lastKeyDown===KeyCode.UP&&(game.input.lastKeyDown=KeyCode.EMPTY,--t.slot,t.x=canvas.width/2-ctx.measureText(o[t.slot]).width/2-60,t.y-=80)},render:function(){ctx.fillStyle="#111",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.font="36px Arial",ctx.fillStyle="#fff",ctx.fillText(n,canvas.width/2-ctx.measureText(n).width/2,80),ctx.font="24px Arial";for(var e=0;e<o.length;++e)ctx.fillText(o[e],canvas.width/2-ctx.measureText(o[e]).width/2,200+80*e);ctx.fillText(t.img,t.x,t.y)}}}(),LevelView.prototype=function(){function e(){if(t.player.invincible)return void(0===t.player.invincibleTimer--&&(t.player.invincible=!1,t.player.invincibleTimer=120));for(var e=0;e<t.curLvl.projectiles.length;++e){var n=SAT.testPolygonPolygon(t.player,t.curLvl.projectiles[e]);if(n){--t.player.hp,t.player.invincible=!0;break}}}var t,n=!1,i=!1;return{then:function(e){this.privates.callback=e},init:function(){t=this},update:function(){this.curLvl.update(),this.player.update(),e()},onUpdate:function(e){n=!0,this.onUpdate=e},render:function(){this.curLvl.render(),this.player.render()},onRender:function(e){i=!0,this.onRender=e}}}(),Level1.prototype=function(){return{projectiles:[],init:function(){for(var e=0;e<10;++e){var t=new SAT.Box(new SAT.Vector(Math.floor(Math.random()*canvas.width+0),canvas.height),10,20).toPolygon();t.speed=.1*Math.floor(10*Math.random()+3),this.projectiles.push(t)}},update:function(){for(var e=0;e<this.projectiles.length;++e)this.projectiles[e].pos.y-=this.projectiles[e].speed},render:function(){ctx.fillStyle="#000",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="silver";for(var e=0;e<this.projectiles.length;++e)ctx.fillRect(this.projectiles[e].pos.x,this.projectiles[e].pos.y,10,20)}}}(),Vamp.prototype=function(){var e=new Image,t=!1;e.onload=function(){t=!0},e.src="img/vamp.png";var n=4;return{w:40,h:40,hp:3,invincible:!1,invincibleTimer:120,init:function(){$.extend(this,new SAT.Box(new SAT.Vector(0,0),this.w,this.h).toPolygon())},update:function(){game.input.keysDown[KeyCode.RIGHT]?this.pos.x+=n:game.input.keysDown[KeyCode.LEFT]&&(this.pos.x-=n),game.input.keysDown[KeyCode.UP]?this.pos.y-=n:game.input.keysDown[KeyCode.DOWN]&&(this.pos.y+=n),this.hp<=0&&(alert("You died"),location.reload())},render:function(){var e=!0;if(this.invincible){var t=this.invincibleTimer%30;t>=0&&t<15&&(e=!1)}e&&(ctx.fillStyle="yellow",ctx.fillRect(this.pos.x,this.pos.y,this.w,this.h)),ctx.fillStyle="red";for(var n=0;n<this.hp;++n)ctx.fillRect(this.pos.x-10+20*n,this.pos.y-20,20,10)}}}(),function(){window.game=new GameEngine,game.start();var e=new TitleView("Vamp: The Great and Powerful",(!0));e.then(function(){game.utils.switchView(t)});var t=new GameSaveView;t.then(function(t){t===KeyCode.ESC?game.utils.switchView(e):t===KeyCode.ENTER&&game.utils.switchView(o)});var n=new Vamp,i=new Level1,o=new LevelView(n,i);game.view=e}();