"use strict";function GameEngine(){let t=document.createElement("a");t.href="/#games",t.innerText="Back",t.className="btnBack",document.body.appendChild(t);let e=document.createElement("div");e.className="canvasWrap",window.canvas=document.createElement("canvas"),canvas.setAttribute("width",1008),canvas.setAttribute("height",567),e.appendChild(canvas),document.body.appendChild(e),window.ctx=canvas.getContext("2d"),this.input=new GameInput(this),this.graphics=new GameGraphics(this),this.utils=new GameUtils(this),this.view=new GameView(this),this.init()}function GameInput(){this.keysDown={},this.lastKeyUp=KeyCode.EMPTY,this.lastKeyDown=KeyCode.EMPTY,this.init()}function GameUtils(t){return{switchView:function(e){e.init(),t.view=e}}}function GameGraphics(t){return{isAnimating:!1,repeatAction:function(t,e,i){this.isAnimating=!0;let o=0,n=this,s=setInterval(function(){o++>e?(clearInterval(s),n.isAnimating=!1):i()},t)}}}function GameView(t){this.privates={bgColor:"#ccc"},this.init()}function TitleView(t){this.privates={title:t},this.init()}function GameSaveView(){this.privates={},this.init()}function LevelView(t,e){this.privates={},this.player=t,this.curLvl=e,this.init()}function Level1(){this.init()}GameEngine.prototype=function(){function t(){i.view.update(),s&&i.onUpdate()}function e(){n=requestAnimationFrame(e),i.view.render(),r&&i.onRender()}let i,o,n,s=!1,r=!1;return{init:function(){i=this},onUpdate:function(t){s=!0,this.onUpdate=t},onRender:function(t){r=!0,this.onRender=t},start:()=>{o=setInterval(t,1e3/60),n=requestAnimationFrame(e)},stop:()=>{clearInterval(o),cancelAnimationFrame(n)}}}();class GameSave{load(t){return localStorage[`slot ${t}`]}getList(){const t=this.load(0),e=this.load(1),i=this.load(2);return[void 0!==t?t:"---",void 0!==e?e:"---",void 0!==i?i:"---"]}save(t,e){localStorage[`slot ${t}`]=e}erase(t){return localStorage.removeItem(`slot ${t}`),this.getList()}}GameInput.prototype=function(){function t(t){return t===KeyCode.W?t=KeyCode.UP:t===KeyCode.S?t=KeyCode.DOWN:t===KeyCode.D?t=KeyCode.RIGHT:t===KeyCode.A&&(t=KeyCode.LEFT),t}let e;return addEventListener("keydown",function(i){let o=t(i.keyCode);e.keysDown[o]||(e.lastKeyDown=o,e.keysDown[o]=!0)}),addEventListener("keyup",function(i){e.lastKeyUp=t(i.keyCode),delete e.keysDown[e.lastKeyUp]}),{init:function(){e=this},update:function(){}}}();const KeyCode={EMPTY:-1,ENTER:13,CTRL:17,ESC:27,SPACEBAR:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,A:65,D:68,F:70,H:72,J:74,K:75,M:77,O:79,R:82,S:83,W:87};let KeyCodeNames={};KeyCodeNames[-1]="EMPTY",KeyCodeNames[13]="ENTER",KeyCodeNames[17]="CTRL",KeyCodeNames[27]="ESC",KeyCodeNames[32]="SPACEBAR",KeyCodeNames[37]="LEFT",KeyCodeNames[38]="UP",KeyCodeNames[39]="RIGHT",KeyCodeNames[40]="DOWN",KeyCodeNames[46]="DELETE",KeyCodeNames[65]="A",KeyCodeNames[68]="D",KeyCodeNames[70]="F",KeyCodeNames[72]="H",KeyCodeNames[74]="J",KeyCodeNames[75]="K",KeyCodeNames[77]="M",KeyCodeNames[79]="O",KeyCodeNames[82]="R",KeyCodeNames[83]="S",KeyCodeNames[87]="W";const Dir={RIGHT:0,LEFT:1};!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.SAT=e()}(this,function(){function t(t,e){this.x=t||0,this.y=e||0}function e(e,i){this.pos=e||new t,this.r=i||0}function i(e,i){this.pos=e||new t,this.angle=0,this.offset=new t,this.setPoints(i||[])}function o(e,i,o){this.pos=e||new t,this.w=i||0,this.h=o||0}function n(){this.a=null,this.b=null,this.overlapN=new t,this.overlapV=new t,this.clear()}function s(t,e,i){for(var o=Number.MAX_VALUE,n=-Number.MAX_VALUE,s=t.length,r=0;r<s;r++){var a=t[r].dot(e);a<o&&(o=a),a>n&&(n=a)}i[0]=o,i[1]=n}function r(t,e,i,o,n,r){var a=y.pop(),p=y.pop(),l=c.pop().copy(e).sub(t),h=l.dot(n);if(s(i,n,a),s(o,n,p),p[0]+=h,p[1]+=h,a[0]>p[1]||p[0]>a[1])return c.push(l),y.push(a),y.push(p),!0;if(r){var u=0;if(a[0]<p[0])r.aInB=!1,a[1]<p[1]?(u=a[1]-p[0],r.bInA=!1):u=(f=a[1]-p[0])<(d=p[1]-a[0])?f:-d;else if(r.bInA=!1,a[1]>p[1])u=a[0]-p[1],r.aInB=!1;else{var f=a[1]-p[0],d=p[1]-a[0];u=f<d?f:-d}var v=Math.abs(u);v<r.overlap&&(r.overlap=v,r.overlapN.copy(n),u<0&&r.overlapN.reverse())}return c.push(l),y.push(a),y.push(p),!1}function a(t,e){var i=t.len2(),o=e.dot(t);return o<0?v:o>i?m:w}function p(t,e,i){for(var o=c.pop().copy(e.pos).sub(t.pos),n=e.r,s=n*n,r=t.calcPoints,p=r.length,l=c.pop(),h=c.pop(),u=0;u<p;u++){var y=u===p-1?0:u+1,f=0===u?p-1:u-1,d=0,w=null;l.copy(t.edges[u]),h.copy(o).sub(r[u]),i&&h.len2()>s&&(i.aInB=!1);var x=a(l,h);if(x===v){l.copy(t.edges[f]);var g=c.pop().copy(o).sub(r[f]);if((x=a(l,g))===m){if((K=h.len())>n)return c.push(o),c.push(l),c.push(h),c.push(g),!1;i&&(i.bInA=!1,w=h.normalize(),d=n-K)}c.push(g)}else if(x===m){if(l.copy(t.edges[y]),h.copy(o).sub(r[y]),(x=a(l,h))===v){if((K=h.len())>n)return c.push(o),c.push(l),c.push(h),!1;i&&(i.bInA=!1,w=h.normalize(),d=n-K)}}else{var C=l.perp().normalize(),K=h.dot(C),T=Math.abs(K);if(K>0&&T>n)return c.push(o),c.push(C),c.push(h),!1;i&&(w=C,d=n-K,(K>=0||d<2*n)&&(i.bInA=!1))}w&&i&&Math.abs(d)<Math.abs(i.overlap)&&(i.overlap=d,i.overlapN.copy(w))}return i&&(i.a=t,i.b=e,i.overlapV.copy(i.overlapN).scale(i.overlap)),c.push(o),c.push(l),c.push(h),!0}function l(t,e,i){for(var o=t.calcPoints,n=o.length,s=e.calcPoints,a=s.length,p=0;p<n;p++)if(r(t.pos,e.pos,o,s,t.normals[p],i))return!1;for(p=0;p<a;p++)if(r(t.pos,e.pos,o,s,e.normals[p],i))return!1;return i&&(i.a=t,i.b=e,i.overlapV.copy(i.overlapN).scale(i.overlap)),!0}var h={};h.Vector=t,h.V=t,t.prototype.copy=t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this},t.prototype.clone=t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.perp=t.prototype.perp=function(){var t=this.x;return this.x=this.y,this.y=-t,this},t.prototype.rotate=t.prototype.rotate=function(t){var e=this.x,i=this.y;return this.x=e*Math.cos(t)-i*Math.sin(t),this.y=e*Math.sin(t)+i*Math.cos(t),this},t.prototype.reverse=t.prototype.reverse=function(){return this.x=-this.x,this.y=-this.y,this},t.prototype.normalize=t.prototype.normalize=function(){var t=this.len();return t>0&&(this.x=this.x/t,this.y=this.y/t),this},t.prototype.add=t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},t.prototype.sub=t.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this},t.prototype.scale=t.prototype.scale=function(t,e){return this.x*=t,this.y*=e||t,this},t.prototype.project=t.prototype.project=function(t){var e=this.dot(t)/t.len2();return this.x=e*t.x,this.y=e*t.y,this},t.prototype.projectN=t.prototype.projectN=function(t){var e=this.dot(t);return this.x=e*t.x,this.y=e*t.y,this},t.prototype.reflect=t.prototype.reflect=function(t){var e=this.x,i=this.y;return this.project(t).scale(2),this.x-=e,this.y-=i,this},t.prototype.reflectN=t.prototype.reflectN=function(t){var e=this.x,i=this.y;return this.projectN(t).scale(2),this.x-=e,this.y-=i,this},t.prototype.dot=t.prototype.dot=function(t){return this.x*t.x+this.y*t.y},t.prototype.len2=t.prototype.len2=function(){return this.dot(this)},t.prototype.len=t.prototype.len=function(){return Math.sqrt(this.len2())},h.Circle=e,e.prototype.getAABB=e.prototype.getAABB=function(){var e=this.r;return new o(this.pos.clone().sub(new t(e,e)),2*e,2*e).toPolygon()},h.Polygon=i,i.prototype.setPoints=i.prototype.setPoints=function(e){if(!this.points||this.points.length!==e.length){var i,o=this.calcPoints=[],n=this.edges=[],s=this.normals=[];for(i=0;i<e.length;i++)o.push(new t),n.push(new t),s.push(new t)}return this.points=e,this._recalc(),this},i.prototype.setAngle=i.prototype.setAngle=function(t){return this.angle=t,this._recalc(),this},i.prototype.setOffset=i.prototype.setOffset=function(t){return this.offset=t,this._recalc(),this},i.prototype.rotate=i.prototype.rotate=function(t){for(var e=this.points,i=e.length,o=0;o<i;o++)e[o].rotate(t);return this._recalc(),this},i.prototype.translate=i.prototype.translate=function(t,e){for(var i=this.points,o=i.length,n=0;n<o;n++)i[n].x+=t,i[n].y+=e;return this._recalc(),this},i.prototype._recalc=function(){var t,e=this.calcPoints,i=this.edges,o=this.normals,n=this.points,s=this.offset,r=this.angle,a=n.length;for(t=0;t<a;t++){var p=e[t].copy(n[t]);p.x+=s.x,p.y+=s.y,0!==r&&p.rotate(r)}for(t=0;t<a;t++){var l=e[t],h=t<a-1?e[t+1]:e[0],c=i[t].copy(h).sub(l);o[t].copy(c).perp().normalize()}return this},i.prototype.getAABB=i.prototype.getAABB=function(){for(var e=this.calcPoints,i=e.length,n=e[0].x,s=e[0].y,r=e[0].x,a=e[0].y,p=1;p<i;p++){var l=e[p];l.x<n?n=l.x:l.x>r&&(r=l.x),l.y<s?s=l.y:l.y>a&&(a=l.y)}return new o(this.pos.clone().add(new t(n,s)),r-n,a-s).toPolygon()},h.Box=o,o.prototype.toPolygon=o.prototype.toPolygon=function(){var e=this.pos,o=this.w,n=this.h;return new i(new t(e.x,e.y),[new t,new t(o,0),new t(o,n),new t(0,n)])},h.Response=n,n.prototype.clear=n.prototype.clear=function(){return this.aInB=!0,this.bInA=!0,this.overlap=Number.MAX_VALUE,this};for(var c=[],u=0;u<10;u++)c.push(new t);for(var y=[],u=0;u<5;u++)y.push([]);var f=new n,d=new o(new t,1e-6,1e-6).toPolygon();h.isSeparatingAxis=r;var v=-1,w=0,m=1;return h.pointInCircle=function(t,e){var i=c.pop().copy(t).sub(e.pos),o=e.r*e.r,n=i.len2();return c.push(i),n<=o},h.pointInPolygon=function(t,e){d.pos.copy(t),f.clear();var i=l(d,e,f);return i&&(i=f.aInB),i},h.testCircleCircle=function(t,e,i){var o=c.pop().copy(e.pos).sub(t.pos),n=t.r+e.r,s=n*n,r=o.len2();if(r>s)return c.push(o),!1;if(i){var a=Math.sqrt(r);i.a=t,i.b=e,i.overlap=n-a,i.overlapN.copy(o.normalize()),i.overlapV.copy(o).scale(i.overlap),i.aInB=t.r<=e.r&&a<=e.r-t.r,i.bInA=e.r<=t.r&&a<=t.r-e.r}return c.push(o),!0},h.testPolygonCircle=p,h.testCirclePolygon=function(t,e,i){var o=p(e,t,i);if(o&&i){var n=i.a,s=i.aInB;i.overlapN.reverse(),i.overlapV.reverse(),i.a=i.b,i.b=n,i.aInB=i.bInA,i.bInA=s}return o},h.testPolygonPolygon=l,h}),GameView.prototype={then:function(t){this.privates.callback=t},init:function(){},update:function(){},render:function(){ctx.fillStyle=this.privates.bgColor,ctx.fillRect(0,0,canvas.width,canvas.height)}},TitleView.prototype=function(){let t,e="Press Enter";return{then:function(t){this.privates.callback=t},init:function(){t=this.privates.title},update:function(){game.input.lastKeyDown===KeyCode.ENTER&&(game.input.lastKeyDown=KeyCode.EMPTY,this.privates.callback())},render:()=>{ctx.fillStyle="#000",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.font="36px Arial",ctx.fillStyle="#fff",ctx.fillText(t,canvas.width/2-ctx.measureText(t).width/2,100),ctx.font="24px Arial",ctx.fillText(e,canvas.width/2-ctx.measureText(e).width/2,canvas.height/2)}}}(),GameSaveView.prototype=function(){let t,e,i="Select a save slot",o=new GameSave,n=o.getList();return{then:function(t){this.privates.callback=t},init:function(){t=this,e={img:">>",slot:0,x:canvas.width/2-ctx.measureText(n[0]).width/2-60,y:200}},update:function(){if(game.input.lastKeyDown===KeyCode.ESC)game.input.lastKeyDown=KeyCode.EMPTY,this.privates.callback(KeyCode.ESC);else if(game.input.lastKeyDown===KeyCode.ENTER){game.input.lastKeyDown=KeyCode.EMPTY;const t=new Date,i=t.getMonth()+1,n=t.getDate(),s=t.getFullYear(),r=t.toLocaleTimeString();o.save(e.slot,`${i}/${n}/${s} ${r}`),this.privates.callback(KeyCode.ENTER)}else game.input.lastKeyDown===KeyCode.DELETE?(game.input.lastKeyDownp=KeyCode.EMPTY,n=o.erase(e.slot)):2!==e.slot&&game.input.lastKeyDown===KeyCode.DOWN?(game.input.lastKeyDown=KeyCode.EMPTY,++e.slot,e.x=canvas.width/2-ctx.measureText(n[e.slot]).width/2-60,e.y+=80):0!==e.slot&&game.input.lastKeyDown===KeyCode.UP&&(game.input.lastKeyDown=KeyCode.EMPTY,--e.slot,e.x=canvas.width/2-ctx.measureText(n[e.slot]).width/2-60,e.y-=80)},render:function(){ctx.fillStyle="#111",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.font="36px Arial",ctx.fillStyle="#fff",ctx.fillText(i,canvas.width/2-ctx.measureText(i).width/2,80),ctx.font="24px Arial";for(let t=0;t<n.length;++t)ctx.fillText(n[t],canvas.width/2-ctx.measureText(n[t]).width/2,200+80*t);ctx.fillText(e.img,e.x,e.y)}}}(),LevelView.prototype=function(){function t(){if(e.player.invincible)0==e.player.invincibleTimer--&&(e.player.invincible=!1,e.player.invincibleTimer=120);else for(var t=0;t<e.curLvl.projectiles.length;++t)if(SAT.testPolygonPolygon(e.player,e.curLvl.projectiles[t])){--e.player.hp,e.player.invincible=!0;break}}let e,i=!1,o=!1;return{then:function(t){this.privates.callback=t},init:function(){e=this},update:function(){this.curLvl.update(),this.player.update(),t()},onUpdate:function(t){i=!0,this.onUpdate=t},render:function(){this.curLvl.render(),this.player.render()},onRender:function(t){o=!0,this.onRender=t}}}(),Level1.prototype={projectiles:[],init:function(){for(var t=0;t<10;++t){var e=new SAT.Box(new SAT.Vector(Math.floor(Math.random()*canvas.width+0),canvas.height),10,20).toPolygon();e.speed=.1*Math.floor(10*Math.random()+3),this.projectiles.push(e)}},update:function(){for(let t=0;t<this.projectiles.length;++t)this.projectiles[t].pos.y-=this.projectiles[t].speed},render:function(){ctx.fillStyle="#000",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="silver";for(let t=0;t<this.projectiles.length;++t)ctx.fillRect(this.projectiles[t].pos.x,this.projectiles[t].pos.y,10,20)}};class Vamp{constructor(){this.speed=4,this.w=40,this.h=40,this.hp=3,this.invincible=!1,this.invincibleTimer=120,this.dead=!1,$.extend(this,new SAT.Box(new SAT.Vector(0,0),this.w,this.h).toPolygon())}update(){game.input.keysDown[KeyCode.RIGHT]?this.pos.x+=this.speed:game.input.keysDown[KeyCode.LEFT]&&(this.pos.x-=this.speed),game.input.keysDown[KeyCode.UP]?this.pos.y-=this.speed:game.input.keysDown[KeyCode.DOWN]&&(this.pos.y+=this.speed),this.hp<=0&&!this.dead&&(this.dead=!0,alert("You died"),location.reload())}render(){let t=!0;if(this.invincible){const e=this.invincibleTimer%30;e>=0&&e<15&&(t=!1)}t&&(ctx.fillStyle="yellow",ctx.fillRect(this.pos.x,this.pos.y,this.w,this.h)),ctx.fillStyle="red";for(let t=0;t<this.hp;++t)ctx.fillRect(this.pos.x-10+20*t,this.pos.y-20,20,10)}}(()=>{window.game=new GameEngine,game.start();let t=new TitleView("Vamp: The Great and Powerful",!0),e=new GameSaveView;const i=new LevelView(new Vamp,new Level1);t.then(()=>{game.utils.switchView(e)}),e.then(e=>{e===KeyCode.ESC?game.utils.switchView(t):e===KeyCode.ENTER&&game.utils.switchView(i)}),game.view=t})();