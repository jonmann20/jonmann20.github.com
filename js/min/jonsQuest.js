utils=function(){var b=1,a=true;return{playSound:function(d,c){c=(typeof(c)!=="undefined")?c:true;if(d.ended){d.play()}else{if(c||d.currentTime==0){d.pause();d.currentTime=0;d.play()}}},muteHelper:function(){if($(".audioState").hasClass("off")){$(".audioState span").removeClass("icon-volume-mute").addClass("icon-volume-medium");$(".audioState").removeClass("off");$(".audioState").addClass("on");utils.muteSound(false)}else{$(".audioState span").removeClass("icon-volume-medium").addClass("icon-volume-mute");$(".audioState").removeClass("on");$(".audioState").addClass("off");utils.muteSound(true)}},muteSound:function(d){game.sound.isOn=!d;var c=d?0:0.25;switch(game.lvl){case -1:game.sound.bgMusic.start.muted=d;d?game.sound.bgMusic.start.pause():game.sound.bgMusic.start.play();break;case 0:game.sound.bgMusic.lvl0.muted=d;d?game.sound.bgMusic.lvl0.pause():game.sound.bgMusic.lvl0.play();break}game.sound.gun.muted=d;game.sound.gun.volume=c;game.sound.thud.muted=d;game.sound.thud.volume=c;game.sound.jump.muted=d;game.sound.jump.volume=c;game.sound.step.muted=d;game.sound.step.volume=c;game.sound.death.muted=d;game.sound.death.volume=c},blinkText:function(e,c,h,f){f=(typeof(f)!=="undefined")?f:"PRESS ENTER";if(b<=0){a=false}else{if(b>1.55){a=true}}var g=game.dt/1000;b+=a?-g:g;ctx.font=e+"px 'Press Start 2P'";var d=ctx.measureText(f).width;ctx.fillStyle="rgba(233, 233, 233,"+b+")";ctx.fillText(f,c-d/2,h)},isCollision:function(d,c,e,g){var f=(typeof(g)!=="undefined")?d.x+d.lvlX:d.x;if((f+e<=(c.x+c.w))&&(c.x+e<=(f+d.w))&&(d.y+e<=(c.y+c.h))&&(c.y+e<=(d.y+d.h))){return true}return false},drawEllipse:function(l,k,m,f){var j=0.5522848,e=(m/2)*j,c=(f/2)*j,n=l+m,i=k+f,g=l+m/2,d=k+f/2;ctx.beginPath();ctx.moveTo(l,d);ctx.bezierCurveTo(l,d-c,g-e,k,g,k);ctx.bezierCurveTo(g+e,k,n,d-c,n,d);ctx.bezierCurveTo(n,d+c,g+e,i,g,i);ctx.bezierCurveTo(g-e,i,l,d+c,l,d);ctx.closePath();ctx.fill()}}}();Dir=Object.freeze({NONE:0,TOP:1,BOT:2,LEFT:3,RIGHT:4});Inv_e=Object.freeze({NOT_HIT:0,HIT_WHITE:1,HIT_RED:2});bullet={color:"rgba(192, 192, 192, .75)",w:19.5,h:9,speed:8};window.GameObj=function(){var a=null,b=false;return{initX:-1,x:-1,initY:-1,y:-1,w:-1,h:-1,vY:0,init:function(f,g,d,c,e){this.initX=this.x=f;this.intiY=this.y=g;this.w=d;this.h=c;if(typeof(e)!=="undefined"){a=new Image();a.onload=function(){b=true};a.src=e}},updatePos:function(){if(this.y<FULLH-game.padFloor-this.h){this.y+=this.vY}else{this.y=FULLH-game.padFloor-this.h}},draw:function(){if(b){ctx.drawImage(a,this.x,this.y)}else{ctx.fillStyle="red";ctx.fillRect(this.x,this.y,this.w,this.h)}}}};window.GameItem=function(){var a=null;function b(){return function(){if(this.visible&&!this.collected){a.apply(this)}}}return{collected:false,holding:false,visible:true,val:-1,init:function(d,c,e){$.extend(this,d);this.val=c;if(typeof(e)!=="undefined"){this.visible=e}a=this.draw;this.draw=b()}}};Enemy=function(){var b=null,c=0;function a(f){var e=(f.w/c)*f.health;ctx.fillStyle="red";ctx.fillRect(f.x,f.y-12,e,4)}function d(){return function(){if(this.health>0){a(this);b.apply(this)}}}return{active:false,health:0,init:function(f,e){$.extend(this,f);this.health=c=e;b=this.draw;this.draw=d()},update:function(){if(this.active&&game.totalTicks%3==0){if(this.x<hero.x){++this.x}else{if(this.x>hero.x){--this.x}}}}}};startScreen=function(){var c=0,a="JON'S QUEST",e="Â© 2013 JON WIEDMANN";function d(){if(13 in keysDown){++game.lvl;game.sound.bgMusic.start.pause();game.sound.bgMusic.lvl0.loop=true;game.sound.isOn?game.sound.bgMusic.lvl0.play():game.sound.bgMusic.lvl0.pause();game.loop()}else{requestAnimFrame(startScreen.loop)}}function b(){ctx.fillStyle="#000";ctx.fillRect(0,0,FULLW,FULLH+game.padHUD);ctx.font="36px 'Press Start 2P'";ctx.fillStyle="#222";ctx.fillText(a,HALFW-ctx.measureText(a).width/2+4,94);ctx.fillStyle="#ff6a00";ctx.fillText(a,HALFW-ctx.measureText(a).width/2,90);utils.blinkText(25,HALFW,HALFH+80);ctx.font="13px 'Press Start 2P'";ctx.fillStyle="#ddd";ctx.fillText(e,HALFW-ctx.measureText(e).width/2,FULLH+44)}return{loop:function(){d();b();var f=new Date().getTime();game.dt=f-(c||f);c=f}}}();function checkInput(){hero.dir=Dir.NONE;if(!hero.onObj){hero.vY=((hero.vY+game.gravity)>hero.maxVy)?hero.maxVy:(hero.vY+game.gravity)}if(hero.vX!=0){hero.vX+=(hero.vX>0)?-game.friction:game.friction}if(65 in keysDown){hero.vX=(Math.abs(hero.vX-hero.speed)>hero.maxVx)?-hero.maxVx:(hero.vX-hero.speed);hero.dirR=false;hero.dir=Dir.LEFT}if(68 in keysDown){hero.vX=(Math.abs(hero.vX+hero.speed)>hero.maxVx)?hero.maxVx:(hero.vX+hero.speed);hero.dirR=true;hero.dir=Dir.RIGHT}if(Math.abs(hero.vX)<hero.speed){hero.vX=0}if(74 in keysDown){if(hero.ammo>0&&!hero.isCarrying){utils.playSound(game.sound.gun);hero.bulletArr[hero.bulletArr.length]={x:hero.x,y:hero.y,w:bullet.w,h:bullet.h,dirR:hero.dirR};--hero.ammo}delete keysDown[74]}if(75 in keysDown){if(!hero.isJumping){game.sound.jump.play();hero.vY=0;hero.isJumping=true;hero.offObj();delete keysDown[75]}}if(hero.isJumping){if(hero.jumpMod>0){hero.vY-=hero.jumpMod;--hero.jumpMod}hero.dir=Dir.TOP}else{hero.jumpMod=hero.jumpPower}if(32 in keysDown){lvl0.crate.holding=false;hero.isCarrying=false}if(72 in keysDown){if(hero.medKits>0&&hero.health<hero.maxHealth){++hero.health;--hero.medKits}}if(82 in keysDown){if(hero.manaKits>0&&hero.mana<hero.maxMana){++hero.mana;--hero.manaKits}}}level=function(){var f=null,h=null,j=null,a=null,b=5,g=new Array(b),c=0,e={};function i(){ctx.fillStyle="#070707";ctx.fillRect(0,FULLH,FULLW,game.padHUD);ctx.fillStyle="#ddd";ctx.font="12px 'Press Start 2P'";ctx.fillText("HP-"+hero.healthLvl,15,FULLH+24);ctx.fillText("MP-"+hero.manaLvl,15,FULLH+48);ctx.fillText("XP",15,FULLH+71);ctx.fillText(hero.medKits,210,FULLH+50);a.draw();ctx.fillText(hero.manaKits,315,FULLH+50);j.draw();ctx.fillText(hero.ammo,410,FULLH+50);f.draw();ctx.fillText(hero.cash,515,FULLH+50);h.draw();var k=Math.floor(game.actualTime/60),l=game.actualTime%60;if(l<10){l="0"+l}if(k<10){k="0"+k}ctx.fillText(k+":"+l,FULLW-84,FULLH+34)}function d(m,n){var l=0;for(var k in m){if(m[k]!="none"){e[k]=new Image();e[k].onload=function(){n(this.num)};e[k].src=m[k];e[k].num=l}++l}}return{collisionPts:{},width:0,init:function(){a=new GameObj();a.init(238,FULLH+31,25,24,"img/medKit.png");j=new GameObj();j.init(342,FULLH+31,25,25,"img/syringe.png");f=new GameObj();f.init(447,FULLH+32,24,24,"img/shuriken.png");h=new GameObj();h.init(548,FULLH+33,22,24,"img/cash.png");level.collisionPts={lvl0:{obj0:{x:310,y:161,w:200,h:30},obj1:{x:600,y:95,w:200,h:30},obj2:{x:562,y:230,w:300,h:30}}};for(var k=0;k<b;k++){g[k]={status:false,bgColor:"#"+Math.floor(Math.random()*16777215).toString(16)}}d({lvl0:"img/lvl0.jpg",lvl1:"none"},function(l){g[l].status=true});level.reset();lvl0.init()},reset:function(){level.width=3198;hero.x=23;hero.y=canvas.height-hero.h;hero.isJumping=false;hero.bulletArr.length=0},update:function(){if(game.lvl==0){lvl0.update()}var k=game.lvl+1;if(k>=b){k=b-1}},updateObjs:function(){if(game.lvl==0){lvl0.updateObjs()}},render:function(){if(g[game.lvl].status){ctx.drawImage(e["lvl"+game.lvl],hero.lvlX,0,FULLW,FULLH,0,0,FULLW,FULLH)}else{if(g[game.lvl].bgColor){ctx.fillStyle=g[game.lvl].bgColor}else{ctx.fillStyle="#222"}ctx.fillRect(0,0,FULLW,FULLH)}i();if(game.lvl==0){lvl0.render()}},drawAfterHero:function(){if(game.lvl==0){if(lvl0.crate.holding){lvl0.crate.draw()}}}}}();lvl0=function(){var b=null,a=null,d=null,c=null;return{init:function(){var f=GameObj();f.init(680,71,20,24,"img/sack.png");d=GameItem();d.init(f,5);var h=GameObj();h.init(2100,FULLH-game.padFloor-38+3,28,38,"img/cyborgBnW.png");b=Enemy();b.init(h,5);var e=GameObj();e.init(140,50,22,24,"img/cash.png");a=GameItem();a.init(e,10,false);var g=GameObj();g.init(400,FULLH-game.padFloor-26,24,26,"img/crate.png");lvl0.crate=GameItem();lvl0.crate.init(g);c=GameObj();c.init(1300,80,340,190,"img/belt.png")},update:function(){a.updatePos();b.update();if(!d.collected){if(utils.isCollision(hero,d,0)){d.collected=true;hero.ammo+=d.val}}if(!a.visible){for(var e=0;e<hero.bulletArr.length;++e){if(utils.isCollision(hero.bulletArr[e],a,-17)){a.visible=true;a.vY=3}}}else{if(!a.collected){if(utils.isCollision(hero,a,0)){a.collected=true;hero.cash+=a.val}}}if(!lvl0.crate.holding){if(utils.isCollision(hero,lvl0.crate,12)){hero.isCarrying=true;lvl0.crate.holding=true;lvl0.crate.vY=6.5}}else{if(hero.dirR){lvl0.crate.x=hero.x+22}else{lvl0.crate.x=hero.x-22}lvl0.crate.y=hero.y}lvl0.crate.updatePos();if(b.health>0){if(utils.isCollision(hero,b,0)){b.active=true;if(!hero.invincible){utils.playSound(game.sound.thud,true);hero.invincible=true;--hero.health}}for(var e=0;e<hero.bulletArr.length;e++){var f=false;if(utils.isCollision(hero.bulletArr[e],b,0)){f=true;utils.playSound(game.sound.thud,true)}if(f){b.active=true;hero.bulletArr.splice(e,1);--b.health;if(b.health<=0){utils.playSound(game.sound.death,false);hero.xp+=2}}}}},updateObjs:function(){d.x-=hero.vX;b.x-=hero.vX;a.x-=hero.vX;c.x-=hero.vX;lvl0.crate.x-=hero.vX},render:function(){if(!d.collected){d.draw()}a.draw();b.draw();c.draw();if(!lvl0.crate.holding){lvl0.crate.draw()}else{if(hero.vX==0){lvl0.crate.x+=hero.dirR?-20:24;lvl0.crate.y+=6}}}}}();game=function(){var b=0,e,a=[0];function g(){hero.update();level.update()}function d(){level.render();hero.render();level.drawAfterHero()}function c(h){ctx.fillStyle="#ddd";ctx.font="12px 'Press Start 2P'";if(h!="Infinity"){a.push(h)}if(game.totalTicks%20==0){var k=0;for(var j in a){k+=a[j]}b=Math.floor(k/a.length);a=[]}ctx.fillText(b+" FPS",FULLW-84,FULLH+65)}function f(h){game.dt=h-(e||h);e=h;c(Math.round(1000/game.dt));++game.totalTicks;if(game.totalTicks%60==0){++game.actualTime}}return{gravity:1,friction:0.4,padBot:119,padHUD:80,padFloor:39,lvl:-1,dt:0,fps:60,totalTicks:0,actualTime:0,sound:{bgMusic:{start:new Audio("audio/firstChiptune/firstChiptune.mp3"),lvl0:new Audio("audio/inspiredBySparkMan/sparkBoy.mp3")},gun:new Audio("audio/raygun.mp3"),thud:new Audio("audio/thud.mp3"),step:new Audio("audio/step.mp3"),jump:new Audio("audio/jump.mp3"),death:new Audio("audio/DiscsOfTron_Cascade.mp3"),isOn:false},loop:function(h){checkInput();g();d();f(h);requestAnimFrame(game.loop)}}}();window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||function(a){setTimeout(a,1000/game.fps)}}();hero=function(){var h=false,x=null,q=true,j=false;function i(){if(hero.y<0){hero.y=0;hero.vY=0}else{if(hero.y>(canvas.height-game.padBot-hero.h)){hero.y=canvas.height-game.padBot-hero.h;hero.isJumping=false}else{if(hero.onObj){hero.y=hero.onObjY}}}if(hero.x<0){hero.x=0}else{if(hero.x>(canvas.width-hero.w)){hero.x=canvas.width-hero.w}}}function m(){for(var A=0;A<hero.bulletArr.length;A++){hero.bulletArr[A].x+=hero.bulletArr[A].dirR?bullet.speed:-bullet.speed;var y,z="lvl"+game.lvl,B=false;if(B||hero.bulletArr[A].x>canvas.width||hero.bulletArr[A].x<0){hero.bulletArr.splice(A,1)}}}function p(){m();i();var z,B="lvl"+game.lvl,y=Dir.NONE;for(var A in level.collisionPts[B]){z=level.collisionPts[B][A];if(utils.isCollision(hero,z,0,true)){if(hero.dirR){if(hero.lvlX-hero.x<z.x){hero.onObjX=z.x-hero.lvlX-hero.w;hero.onObjLvlX=hero.lvlX;y=Dir.LEFT}}else{if((hero.x+hero.lvlX+hero.w)>(z.x+z.w)){hero.onObjX=z.x-hero.lvlX+z.w;hero.onObjLvlX=hero.lvlX;y=Dir.RIGHT}}if((hero.x!=hero.onObjX)&&((hero.y+hero.h-17)<z.y)&&(hero.vY>0)){hero.onObjY=hero.y=z.y-hero.h;hero.isJumping=false;hero.onObj=true;y=Dir.TOP}else{if((hero.y+hero.h)>(z.y+z.h)){hero.onObjY=hero.y=z.y+z.h;hero.jumpMod=0;hero.vY=0;y=Dir.BOT}}}if(y!=Dir.NONE){if((y==Dir.LEFT)||(y==Dir.RIGHT)){hero.x=hero.onObjX;hero.lvlX=hero.onObjLvlX}break}}if(y==Dir.NONE){hero.offObj()}}function c(){if(hero.x!=(hero.x+hero.vX)){game.sound.step.play()}hero.y+=hero.vY;if(((hero.dirR&&hero.x>=((canvas.width/2)+35))||(!hero.dirR&&hero.x<=((canvas.width/2)-45)))&&(hero.lvlX+hero.vX>=0)&&(hero.lvlX+hero.vX<=level.width-canvas.width)){hero.lvlX+=hero.vX;level.updateObjs()}else{hero.x+=hero.vX}}var d={x:2,y:2},v={x:32,y:2},a={x:62,y:2},e={x:92,y:2},f={x:2,y:42},r={x:32,y:42},u={x:62,y:42},s={x:92,y:42},w={x:2,y:82},o={x:32,y:82},g={x:62,y:82};function t(){if(h){if(game.totalTicks%12==0){q=q?false:true}var y=Inv_e.NOT_HIT;if(hero.invincible){y=(hero.invincibleTimer%5==0)?Inv_e.HIT_WHITE:Inv_e.HIT_RED}var z={x:0,y:0};if(hero.isCarrying&&hero.vX==0&&hero.dir==Dir.NONE){z=d}else{if(hero.dirR){z=r;if(q&&68 in keysDown){z=s}if(y==Inv_e.HIT_WHITE){z=w}else{if(y==Inv_e.HIT_RED){z=u}}}else{z=v;if(q&&65 in keysDown){z=e}if(y==Inv_e.HIT_WHITE){z=f}else{if(y==Inv_e.HIT_RED){z=a}}}}ctx.drawImage(x,z.x,z.y,hero.w,hero.h,hero.x,hero.y,hero.w,hero.h)}}function n(){for(var z=0;z<hero.bulletArr.length;++z){var y=0;if(hero.bulletArr[z].dirR){y=hero.w/2}ctx.fillStyle=bullet.color;utils.drawEllipse(hero.bulletArr[z].x+y,hero.bulletArr[z].y+4.5,bullet.w,bullet.h)}}function l(){for(var y=0;y<hero.health;++y){ctx.fillStyle="red";ctx.fillRect(80+y*21,FULLH+14,19,8)}}function k(){for(var y=0;y<hero.mana;++y){ctx.fillStyle="#00b6ff";ctx.fillRect(80+y*21,FULLH+37,19,8)}}function b(){ctx.fillStyle="#ddd";ctx.font="12px 'Press Start 2P'";var y=(hero.xp<10)?"0":"";ctx.fillText(y+hero.xp+"/"+hero.xpNeeded,80,FULLH+71)}return{ammo:20,cash:0,x:0,y:0,lvlX:0,w:28,h:38,vX:0,vY:0,maxVx:6,maxVy:15,dir:Dir.NONE,dirR:true,speed:1.5,isJumping:false,isCarrying:false,onObj:true,onObjX:-1,onObjY:-1,jumpMod:5,jumpPower:5,jumpPowerMax:10,invincible:false,invincibleTimer:40,initInvincibleTimer:40,health:4,maxHealth:5,medKits:1,healthLvl:1,mana:0,maxMana:4,manaKits:1,manaLvl:1,lvl:1,xp:0,xpNeeded:50,bulletArr:[],init:function(){x=new Image();x.onload=function(){h=true};x.src="img/player.png"},offObj:function(){hero.onObj=false;hero.onObjX=-1;hero.onObjY=-1},update:function(){c();p();if(hero.invincible){--hero.invincibleTimer}if(hero.invincibleTimer<=0){hero.invincible=false;hero.invincibleTimer=hero.initInvincibleTimer}if(hero.health<=0&&!j){utils.playSound(game.sound.death,false);game.sound.bgMusic.lvl0.muted=true;alert("You died");location.reload();j=true}},render:function(){t();n();l();k();b()}}}();load=function(){function b(){canvas=$("canvas")[0];ctx=canvas.getContext("2d");FULLW=canvas.width=720;FULLH=canvas.height=440;FULLH-=game.padHUD;HALFW=FULLW/2;HALFH=FULLH/2;game.sound.bgMusic.start.loop=true;game.sound.bgMusic.start.pause();utils.muteSound(true);$(".audioState").on("click",function(){utils.muteHelper()});ctx.fillStyle="#e1e1e1";ctx.font="25px Helvetica";ctx.fillText("Loading...",150,canvas.height/2);a()}function a(){keysDown={};addEventListener("keydown",function(c){if(c.keyCode==32){c.preventDefault()}else{if(c.keyCode==77){utils.muteHelper()}}keysDown[c.keyCode]=true},false);addEventListener("keyup",function(c){delete keysDown[c.keyCode]},false)}return{init:function(){b();level.init();hero.init();startScreen.loop()}}}();$(function(){load.init()});