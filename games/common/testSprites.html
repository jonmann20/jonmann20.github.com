<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
</head>
<body>
    <canvas width="500" height="500"></canvas>

    <button>Start</button>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="js/GameInput.js"></script>
    <script>
        // meta
        var canvas = document.getElementsByTagName("canvas")[0];
        var ctx = canvas.getContext("2d");
        var raf;
        var isRunning = false;
        var num = -1;

        // sprites
        var spriteArr = [],
            img = new Image(),
            timer = 0,
            t = 0,
            pos = {x: 0, y: 0}
        ;

        // grab texturePacker's sprite coords
        $.get("img/sprites/player/player.xml", function(xml) {
            var wrap = $(xml).find("sprite");

            $(wrap).each(function() {
                var name = $(this).attr('n'),
                    x = $(this).attr('x'),
                    y = $(this).attr('y');

                name = name.substring(0, name.length - 4);
                spriteArr[name] = {
                    x: x,
                    y: y
                };
            });

            getSpriteImg();
        });

        function getSpriteImg() {
            img.onload = function() {
                drawSprite();
            };
            img.src = "img/sprites/player/player.png";
        }

        function loop() {
            raf = requestAnimationFrame(loop);

            if(++timer > 80)
                timer = 0;

            t = (timer % 80);

            if(t >= 0 && t < 20) {
                num = 1;
            }
            else if(t >= 20 && t < 40) {
                num = 2;
            }
            else if(t >= 40 && t < 60) {
                num = 3;
            }
            else {
                num = 2;
            }

            drawSprite();
        }

        var btn = document.getElementsByTagName("button")[0];
        btn.onclick = function() {
            if(isRunning) {
                isRunning = false;
                this.innerText = "Start";

                cancelAnimationFrame(raf);
            }
            else {
                isRunning = true;
                this.innerText = "Stop";

                requestAnimationFrame(loop);
            }
        };

        function drawSprite() {
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, 500, 500);
            
            ctx.font = "30px Arial";
            ctx.fillStyle = "#000";
            ctx.fillText("Run " + num, 100, 100);


            switch(num) {
                case -1:
                    pos = spriteArr["playerRight"];
                    break;
                case 0:
                    pos = spriteArr["playerRight_Step"];
                    break;
                case 1:
                case 2:
                case 3:
                    pos = spriteArr["playerRight_Run" + num];
                    break;
            }

            ctx.drawImage(img, pos.x, pos.y, 48, 65, 100, 150, 48 * 2, 65 * 2);
        }

        var input = new GameInput();
        input.onKeyDown(function(key) {
            if(key === KeyCode.LEFT) {
                if(--num < -1)
                    num = -1;

                drawSprite();
            }
            else if(key === KeyCode.RIGHT) {
                if(++num > 3)
                    num = 3;

                drawSprite();
            }
            else if(key === KeyCode.SPACEBAR) {
                btn.click();
            }
        });
    </script>
</body>
</html>
